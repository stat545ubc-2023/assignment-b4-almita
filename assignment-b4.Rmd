---
title: "assignment-b4"
author: "Alma Garcia"
date: "2023-12-04"
output: github_document
---

# Strings and functional programming in R

## Exercise 1

For this exercise I chose the book "Frankenstein" by Mary Shelley (a favorite of mine). The book was downloaded as plain text from [Project Gutenberg](https://www.gutenberg.org/ebooks/84). 

```{r}
library(stringr)
library(dplyr)
library(tm)
```

```{r}
con <- file("files/frankenstein.txt")
frankenstein_book <- readLines(con) %>% tolower()
head(frankenstein_book)
```

So the book actually starts at line 70 and ends at line 7385, we will extract the relevant content to work with it. I will also keep lines that have at least 1 character. 

```{r}
frankenstein <- frankenstein_book[70:7385] %>%
	str_subset(".+")

head(frankenstein)
```
Now we need to create our unique words list. 

```{r}
frankenstein_words <- frankenstein %>% 
	str_split("\\s+") %>% # split lines into words
	unlist() %>% # break the list structure
	str_replace_all("[:punct:]", " ") %>% # turns punctuation into spaces (because some words have em dashes between)
	str_subset("^[a-z]+$") # filters out punctuation and numbers
```

```{r}
head(frankenstein_words, 20)
```
And then we need to count the number of unique words so we can create plots:

```{r}
frankenstein_unique <- as_tibble(frankenstein_words) %>%
	filter(!value %in% tm::stopwords("SMART")) %>% # remove stop words
	group_by(value) %>%
	reframe(count = n()) %>%
	rename(word = value) 

head(frankenstein_unique)
```

To visualize the most used words let's make a word cloud using the `wordcloud` package:

```{r}
library(wordcloud)
```

```{r}
# color palette
pal = c("#3C4B69FF", "#4B5A69FF", "#697878FF", "#4B4B4BFF", "#3C3C3CFF", "#3C3C1EFF", "#695A2DFF", "#78693CFF", "#78784BFF", "#C0BB9DFF", "#C2902FFF", "#965A0FFF", "#784B0FFF", "#5A4B0FFF")
```


```{r wordcloud}
wordcloud(frankenstein_unique$word, 
					frankenstein_unique$count, 
					max.words = 500,
					random.order = FALSE, 
					random.color = TRUE,
					scale = c(2.5, 0.05), 
					rot.per=0,
					fixed.asp = FALSE,
					family = "Kingthings Trypewriter 2", 
					font = 1, 
					col = pal)
```

And we'll make another plot, this time a barplot, to show the top 15 words:

```{r bar_plot}
library(ggplot2)

frankenstein_unique %>%
	arrange(desc(count)) %>%
	slice_head(n = 15) %>%
	ggplot(aes(reorder(word, -count), count)) +
	geom_col(fill = pal[1], position = position_dodge(width=0.5)) +
	xlab("word") +
	scale_y_continuous(expand = c(0,0.15)) +
	theme_minimal() +
	theme(text = element_text(color = pal[1], family = "Kingthings Trypewriter 2"),
				axis.title = element_text(size = 16),
				axis.text = element_text(color = pal[1]),
				axis.text.x = element_text(angle = 30, hjust=1),
				axis.ticks.x.bottom = element_line(linewidth = 0.5, color = "#EBEBEB"),
				panel.grid.major.x = element_blank()
				) 
```

## Exercise 3

For this exercise I want to model a difference between albums of some of my favorite artists: alt-J, Arctic Monkeys, Lana del Rey and King Gizzard & the Lizard Wizard (KG&LW). For this I previously generated a dataset using the `spotifyr` package to get the tracks info by these artists (see `spotify.R`). 

The variable I'm most interested in comparing is the `energy` variable. According to the Spotify API `energy` refers to: 

> Energy is a measure from 0.0 to 1.0 and represents a perceptual measure of intensity and activity. Typically, energetic tracks feel fast, loud, and noisy. For example, death metal has high energy, while a Bach prelude scores low on the scale. Perceptual features contributing to this attribute include dynamic range, perceived loudness, timbre, onset rate, and general entropy.

```{r}
library(ggridges)
library(forcats)
library(purrr)
library(broom)
```

```{r}
spotify <- read.csv(file = "files/spotify.csv") %>%
	select(-X, track_name, track_number, artist_name, album_name, album_release_year, energy)

artists <- spotify$artist_name %>% unique()

head(spotify)
```

There are some albums in the dataset that are repeated, are remixes, or live recordings. I will remove those and keep only the artist's distinct albums. 

```{r}
rm_albums <- c("Born To Die", "Born To Die â€“ Paradise Edition (Special Version)", "Born To Die - The Paradise Edition", "Live at the Royal Albert Hall", "This Is All Yours (Album Commentary)", "Reduxer", "The Dream","The Dream (CARBS Remix Edition)", "Live In San Francisco â€™16")

spotify_distinct <- spotify %>%
	filter(!album_name %in% rm_albums) 
```

Let's do some plotting to visualize the differences in energy across time. 

```{r scatter_plots}
spotify_distinct %>%
		ggplot(aes(x = album_release_year, y = energy)) +
		geom_jitter() +
		theme_bw() +
		facet_wrap(~artist_name)
```

There seems to be a somewhat negative trend for Lana del Rey's music getting less energetic throughout the years. Arctic Monkey's las album also seems to be much more less energetic than the rest. alt-J doesn't show much difference, and KG&LW is all over the place.

Another plot that can help visualize this evolution is a ridgeline plot.

```{r}
plot_func <- function(name, df) {
	df %>%
		filter(artist_name == name) %>%
		ggplot(aes(y=fct_reorder(album_name, -album_release_year), 
						 x=energy, 
						 fill=as.factor(album_release_year)
						 )
				 ) +
	geom_density_ridges(aes(height = after_stat(density)), stat = "density", scale = 0.95, color = "#00000040") +
	scale_y_discrete(label = function(x) stringr::str_trunc(x, 20)) +
	scale_fill_discrete(name = "year") +
	ggtitle(name) +
	theme_minimal() +
	theme(
		axis.title.y = element_blank(),
		panel.grid.major.y = element_line(colour = "gray80", linewidth = 0.3),
		panel.grid.major.x = element_line(colour = "gray80", linewidth = 0.3),
		panel.grid.minor.x = element_line(colour = "gray80", linewidth = 0.3),
	) 
}
```

```{r distribution_plots}
walk(artists, \(x) {p <- plot_func(x,spotify_distinct) 
		 print(p)}
		 )
```

So alt-J seems to show little change in energy between albums. Arctic Monkeys and Lana del Rey show a decrease in energy as the years pass. KG&LW usually maintains a relatively high energy throughout their albums with some outliers. 

There are two ways to model this: first a linear regression model to find possible trends in energy across time, the second is an ANOVA test to determine the statistical differences in the mean energy between each album. I will need to assume three things for this analysis:

1. that the data is independent, 
2. that the data is normally distributed 
3. that the data has common variance 

These assumptions are not true but will have to be so for the purposes of this exercise ðŸ˜…. 

For these steps I'll create a new tibble with the nested dataframes, one for each artist:

```{r}
library(tidyr)

spotify_artists <- spotify_distinct %>% 
	nest(.by = artist_name)

spotify_artists
```

## linear model
Now I can fit the linear model and get two important parameters out of it: the slope and the adjusted r squared value
```{r}
spotify_models <- spotify_artists %>%
	mutate(linear_models = map(data, \(x) lm(energy ~ album_release_year, x)),
				 coef = map_dbl(linear_models, \(x) coef(x) %>% .[[2]]),
				 adj_r_sq = map_dbl(linear_models, \(x) summary(x) %>% .$adj.r.squared))

names(spotify_models$data) <- artists

spotify_models
```

So as we could see before, both Arctic Monkeys and Lana del Rey have a negative trend of energy across time (negative slope), with a more pronounced decline in Lana del Rey. However the adjusted R squared value is not particularly high, meaning that the model isn't that well of a fit. In the case of alt-J and KG&LW there is no significant trend and the model doesn't predict at all the behavior of energy across time (notice the negative `adj_r_sq`). 

However after looking at the distribution plots I'm sure there are at least some albums whose average energy is significantly different from the others, at least for Arctic Monkeys, Lana del Rey, and KG&LW. So I'll do an anova model too to determine if there are at least 1 album with a significantly different mean energy than the others for each artist. 

```{r}
spotify_models <- spotify_models %>%
	mutate(aov = map(data, \(x) aov(energy ~ album_name, x)),
				 aov_summary = map(aov, broom::tidy)
				 ) 
names(spotify_models$aov) <- artists
names(spotify_models$aov_summary) <- artists
```

```{r}
spotify_models %>%
	unnest(aov_summary) %>%
	filter(term != "Residuals") %>%
	select(artist_name,p.value)
```

We can see from the p.values that for Arctic Monkeys, Lana del Rey, and KG&LW there is at least 1 album that has a significantly different mean energy from the rest. So now I can perform a Tukey HSD test to see exactly which albums have significantly different mean energy from each other.

```{r}
spotify_models <- spotify_models %>%
	mutate(tukey = map(aov, \(x) TukeyHSD(x) %>% broom::tidy()))

names(spotify_models$tukey) <- artists
```

```{r}
spotify_models %>%
	unnest(tukey) %>%
	filter(adj.p.value < 0.05) %>%
	select(artist_name, contrast, estimate, conf.low, conf.high)
```

The adjusted P value determines if the pairwise comparison (`contrast`) is significantly different (p < 0.05) or not, here I filtered for only significantly different comparisons (p < 0.05). alt-J has none and it's interesting to see that KG&LW has less pairs of albums with significantly different mean energy than Lana del Rey and Arctic Monkeys (8 pairs vs 17 and 9 respectively).

Now I'll make some final plots to show the relationship between albums, the idea is to connect albums that are similar to each other. I'll first make a matrix that contains a 1 if the albums mean energy is significantly similar, then I'll make a network graph. 

```{r}
library(igraph)
gen_comparison_matrix <- function(df, tukey_results) {
	similar_albums <- tukey_results %>% filter(adj.p.value > 0.05)
	
	n = length(unique(df$album_name))
	
	album_matrix <- matrix(0, nrow = n, ncol = n)
	rownames(album_matrix) <- colnames(album_matrix) <- levels(fct_reorder(df$album_name, df$album_release_year))
	
	for (albums in similar_albums$contrast) {
		album_sep <- str_split_1(albums, "-")
		album_matrix[album_sep[1],album_sep[2]] <- 1
		album_matrix[album_sep[2],album_sep[1]] <- 1
	}
	album_matrix
}

spotify_models <- spotify_models %>%
	mutate(album_matrix = map2(data, tukey, \(x,y) gen_comparison_matrix(x,y)))
```

```{r network_plots}
gen_network_plots <- function(artist, matrix) {
	labels <- rownames(matrix) %>% str_trunc(20)
	network <- graph_from_adjacency_matrix(matrix, mode="undirected")
	par(bg="#F7F3EF", mar=c(0,0,2,0))
	set.seed(5)
	plot(network,
    vertex.size=12,
    vertex.color="#F7F3EF", 
    vertex.label=labels,
    vertex.label.cex=0.6,
    vertex.label.color="#605A52",
		vertex.label.family="Kingthings Trypewriter 2",
    vertex.frame.color="#E4DDD2",
		vertex.frame.width = 2,
		edge.color="#E4DDD2",
		edge.width=2,
		edge.curved=0.1
    )
	title(artist,
				family = "Kingthings Trypewriter 2",
				col.main = "#605A52",
				cex.main = 1.2)
}

walk2(artists, spotify_models$album_matrix, \(x,y) gen_network_plots(x,y))

```

So here we have the visual representation of the relationships of the mean energy between each album, if albums (nodes) are connected it means that their mean energy is not statistically different (p < 0.05). It's very interesting to see how certain albums cluster together like Lana del Rey's most recent albums: Blue Banister, Chemtrails Over the Country Club, Norman Fucking Rockwell!, and Did you know that there's a tunnel under ocean boulevard? and how Honeymoon is at the center of both clusters. It is also evident that The Car's mean energy is significantly different from the other Arctic Monkey's albums. KG&LW is pretty messing, they have a ton of albums so it's kinda hard to read ðŸ˜… 

It would've been interesting to include other metrics such as loudness, danceability and valence into the anova models, but I wanted to keep it relatively simple. :)
